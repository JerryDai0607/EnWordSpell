{"version":3,"sources":["../../../../../assets/Scripts/Managers/assets/Scripts/Managers/Server.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../assets/Scripts/Managers","sourcesContent":["\nimport Events from '../Misc/Events';\nimport Config from './Config';\nimport Signal from '../Misc/Signal';\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class Server extends cc.Component {\n\tstatic $: Server = null;\n\n\tws: WebSocket = null;\n\tpid: number = 0;\n\n\tonLoad() {\n\t\tServer.$ = this;\n\t\twhevent.on(Events.MULTIPLAYER, this.connect, this);\n\n\t\twhevent.on(Signal.UUID, this.onUUID, this);\n\t\twhevent.on(Signal.JOIN, this.onJoin, this);\n\t\twhevent.on(Signal.MATCH, this.onMatch, this);\n\t\twhevent.on(Signal.LEAVE, this.onLeave, this);\n\t\twhevent.on(Signal.CORRECT, this.onCorrect, this);\n\t\twhevent.on(Signal.WRONG, this.onWrong, this);\n\t\twhevent.on(Signal.RESULT, this.onResult, this);\n\t}\n\n\tonDestroy() {\n\t\twhevent.off(Events.MULTIPLAYER, this.connect, this);\n\t\twhevent.off(Signal.JOIN, this.onJoin, this);\n\t\twhevent.off(Signal.MATCH, this.onMatch, this);\n\t\twhevent.off(Signal.LEAVE, this.onLeave, this);\n\t\twhevent.off(Signal.CORRECT, this.onCorrect, this);\n\t\twhevent.off(Signal.WRONG, this.onWrong, this);\n\t\twhevent.off(Signal.RESULT, this.onResult, this);\n\t}\n\n\tconnect() {\n\t\twhevent.emit(Events.TIP, {message: 'Connecting...', time: 0});\n\t\tthis.ws = new WebSocket(Config.server);\n\n\t\tthis.ws.addEventListener('open', this.onOpen.bind(this));\n\t\tthis.ws.addEventListener('message', this.onMessage.bind(this));\n\t\tthis.ws.addEventListener('close', this.onClose.bind(this));\n\t}\n\n\tonOpen() {\n\t\twhevent.emit(Events.TIP);\n\t\tcc.log('Connected to the server!');\n\t\tthis.send(Signal.MATCH, { level: 0 });\n\t}\n\n\tonClose() {\n\t\twhevent.emit(Events.TIP, { message: 'Disconnected from server!' });\n\t\tcc.log('Disconnected from the server!');\n\t\tthis.ws.removeEventListener('open', this.onOpen.bind(this));\n\t\tthis.ws.removeEventListener('message', this.onMessage.bind(this));\n\t\tthis.ws.removeEventListener('close', this.onClose.bind(this));\n\t\twhevent.emit(Events.LOST_CONNECTION);\n\t}\n\n\tonMessage({ data }) {\n\t\tlet pack = JSON.parse(atob(data));\n\t\twhevent.emit(pack.signal, pack.data);\n\t\tcc.log('%cRECEIVE:', 'color:#4A3;', pack.signal, pack.data);\n\t}\n\n\tsend(signal: string, data?: any) {\n\t\tcc.log('%cSENDING:', 'color:#36F;', signal, data);\n\t\tthis.ws.send(btoa(JSON.stringify({ signal, data })));\n\t}\n\n\tonUUID(uuid: number) {\n\t\tthis.pid = uuid;\n\t\twhevent.emit(Events.TIP, { message: 'Connected to server!' });\n\t}\n\n\tonJoin(uuid: number) {\n\t\twhevent.emit(Events.TIP, { message: 'Searching for opponents...', time: 0 });\n\t}\n\n\tonMatch({ level, text, time }) {\n\t\twhevent.emit(Events.GAME_START, { online: true, level, text, time });\n\t\twhevent.emit(Events.TIP);\n\t}\n\n\tonLeave(uuid: number) {\n\t\twhevent.emit(Events.TIP, { message: 'Your Opponent has left!' });\n\t}\n\n\tonCorrect({ uuid, ids, word, letters, score }) {\n\t\twhevent.emit(Events.CORRECT, { me: this.pid === uuid, ids, word, letters, score });\n\t}\n\n\tonWrong({ uuid, ids, word }) {\n\t\tif (uuid !== this.pid) return;\n\t\twhevent.emit(Events.WRONG, { ids, word });\n\t}\n\n\tonResult({ interrupted, score }) {\n\t\tlet myScore = 0;\n\t\tlet theirScore = 0;\n\t\tfor (let id in score) {\n\t\t\tif (parseInt(id) === this.pid) {\n\t\t\t\tmyScore = score[id].score;\n\t\t\t} else {\n\t\t\t\ttheirScore = score[id].score;\n\t\t\t}\n\t\t}\n\t\tif (!interrupted) {\n\t\t\tif (myScore > theirScore) {\n\t\t\t\twhevent.emit(Events.TIP, { message: 'Winner!' });\n\t\t\t} else if (myScore < theirScore) {\n\t\t\t\twhevent.emit(Events.TIP, { message: 'Good effort!' });\n\t\t\t} else {\n\t\t\t\twhevent.emit(Events.TIP, { message: 'Draw!' });\n\t\t\t}\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\twhevent.emit(Events.MAIN_MENU);\n\t\t}, 2000);\n\t}\n}\n"]}